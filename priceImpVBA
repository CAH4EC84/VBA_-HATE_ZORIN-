Public Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal Milliseconds As LongPtr) 'Äëÿ Sleep
'Àöêèé àä ìîè ãëàçà âûòåêëè êîãäà âûÿñíèëîñü ÷òî íàäî ïåðåïèñàòü ýòî ñ àóòëóêà 2000 íà àóòëóê 2010.

Sub OutL()
Dim WorkDir As String

Dim myOlApp As New Outlook.Application
Dim myNameSpace As Outlook.NameSpace
Dim myInbox As Outlook.MAPIFolder
Dim myitems As Outlook.Items
Dim myitem As Object
Dim Found As Boolean
Dim Recipient
Dim Attachs

Set myNameSpace = myOlApp.GetNamespace("MAPI")
Set myInboxdef = myNameSpace.GetDefaultFolder(olFolderInbox)
Set myitemsDef = myInboxdef.Items

Set myInbox = myNameSpace.Folders(3).Folders(2)
Set myitems = myInbox.Items

Found = False

'Make Reference to Microsoft AxticX Data Objects Library
'Dim dbConn As ADODB.Connection, dbRecSet As ADODB.Recordset
Dim sConnString As String, sQuery As String
Dim sDBPath As String
'Define MDB ACCESS file path
sDBPath = "z:\prices_2000.accdb"
    
'SQL Query String
    sQuery = "SELECT DISTINCT pricemail,ident, arx,fileext,extrcmd   FROM _Info;"
    
    'ADODB Conenction String to initiate connection with MDB ACCESS
    sConnString = "Provider=Microsoft.ace.OLEDB.12.0; Data Source=" & sDBPath & ";"
    
    'Open Connection
    Set dbConn = New ADODB.Connection
    dbConn.Open ConnectionString:=sConnString
    
    'Execute SQL Query & Get Records matching the query to recordset
    Set dbRecSet = New ADODB.Recordset
    dbRecSet.Open Source:=sQuery, ActiveConnection:=dbConn
    

For Each myitem In myitems 'Äëÿ êàæäîãî ïèñüìà
WorkDir = "z:\"
    AttachName = FileName = FileExt = ""
    If myitem.Class = olMail Then
        If myitem.Attachments.Count > 0 Then 'ïðè íàëè÷è âëîæåíèÿ
        
        dbRecSet.MoveFirst 'èäåì íà ïåðâóþ ñòðî÷êó òàáëèöû
        Do While Not dbRecSet.EOF  'ïðîáåãàåìñÿ ïî òàáëèöå
    
            
                If (UCase(myitem.Recipients(1).Address)) = UCase(dbRecSet.Fields(0).Value) Then 'åñëè ïî÷òà çàðåãèñòðèðîâàíà
                   'MsgBox ("Find mail address")
                    For Each Attach In myitem.Attachments 'Ñîõðàíÿåì âëîæåíèÿ
                        WorkDir = "z:\"
                        Attach.SaveAsFile (WorkDir & dbRecSet.Fields(1).Value & "\Archive." & dbRecSet.Fields(2).Value)  ' Çàäàåì èìÿ äëÿ ñîõðàíåíèÿ è ñîõðàíÿåì (arx)
                        If Err.Number = 0 Then 'Åñëè ñîõðàíèëîñü òî ðàñïàêîâûâàåì è ïåðåèìåíîâûâàåì
                            'òóò  ÷åðåç îäíî ìåñòî =)
                            extrCmd = dbRecSet.Fields(4).Value
                            AttachName = "Archive." & dbRecSet.Fields(2).Value
                            WorkDir = WorkDir & dbRecSet.Fields(1).Value
                            FileName = dbRecSet.Fields(1).Value
                            FileExt = dbRecSet.Fields(3).Value
                            
                            'Ôîðìèðóåì èç øàáëîííîé ñòðîêè èíäèâèäóàëüíóþ %WD\..\ExtrMv.cmd %WD %AN %FN %FE
                            extrCmd = Replace(extrCmd, "%WD", WorkDir)
                            extrCmd = Replace(extrCmd, "%AN", WorkDir & "\" & AttachName)
                            extrCmd = Replace(extrCmd, "%FN", WorkDir & "\" & FileName)
                            
                            extrCmd = Replace(extrCmd, "%FE", FileExt)
                            extrCmd = extrCmd & " " & dbRecSet.Fields(4).Value
                             If UCase((dbRecSet.Fields(4).Value)) = "RAR" Then MsgBox (myitem.Recipients(1).Address)
                            'Íàïèñàòü ïðîâåðêó äëÿ RAR ôàéëîâ. äîáàâèòü 4ûé ïàðàìåòð ðàñøèðåíèå ôàéëà âíóòðè àðõèâà.
                            
                            Shell (extrCmd)
                            Else
                            MsgBox ("CHECK:" & (WorkDir & dbRecSet.Fields(1).Value & "\Archive." & dbRecSet.Fields(2).Value))
                            Err.Number = 0
                         End If
                         
                    Next Attach
                End If
                If Not dbRecSet.EOF Then
                dbRecSet.MoveNext
                End If
        Loop
        End If
    End If
    myitem.Delete
    'myitem.FlagIcon (olRedFlagIcon) 'olRedFlagIcon 'olNoFlagIcon
Sleep (500)
Next myitem
MsgBox ("it's stop")

End Sub



